generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Team {
  id             Int                 @id @default(autoincrement())
  fplId          Int                 @unique
  name           String
  shortName      String
  sofascoreId    Int?                @unique
  understatId    String?             @unique
  stadium        String?
  founded        Int?
  primaryColor   String?
  secondaryColor String?
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  lastSyncedAt   DateTime?
  externalStats  ExternalTeamStats[]
  awayMatches    Match[]             @relation("AwayTeam")
  homeMatches    Match[]             @relation("HomeTeam")
  players        Player[]

  @@index([fplId])
  @@index([sofascoreId])
  @@map("teams")
}

model Player {
  id              Int                   @id @default(autoincrement())
  fplId           Int                   @unique
  code            Int                   @unique
  webName         String
  firstName       String
  secondName      String
  position        Position
  teamId          Int
  squadNumber     Int?
  nowCost         Int
  selectedBy      Float
  totalPoints     Int
  pointsPerGame   Float
  form            Float
  status          String?
  news            String?
  newsAdded       DateTime?
  chanceOfPlaying Int?
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  lastSyncedAt    DateTime?
  externalStats   ExternalPlayerStats[]
  fantasyPicks    FantasyTeamPick[]
  fplStats        FPLPlayerStats[]
  playerMappings  PlayerMapping[]
  team            Team                  @relation(fields: [teamId], references: [id])
  watchlist       Watchlist[]

  @@index([fplId])
  @@index([teamId])
  @@index([position])
  @@map("players")
}

model PlayerMapping {
  id         Int           @id @default(autoincrement())
  playerId   Int
  source     String
  externalId String
  method     MappingMethod
  status     MappingStatus @default(PENDING)
  confidence Float         @default(0)
  mappedBy   String?
  mappedAt   DateTime      @default(now())
  verifiedAt DateTime?
  notes      String?
  player     Player        @relation(fields: [playerId], references: [id])

  @@unique([playerId, source])
  @@index([source, externalId])
  @@map("player_mappings")
}

model Match {
  id          Int              @id @default(autoincrement())
  fplId       Int              @unique
  gameweek    Int
  homeTeamId  Int
  awayTeamId  Int
  kickoffTime DateTime
  homeScore   Int?
  awayScore   Int?
  finished    Boolean          @default(false)
  started     Boolean          @default(false)
  sofascoreId Int?             @unique
  understatId String?          @unique
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  playerStats FPLPlayerStats[]
  awayTeam    Team             @relation("AwayTeam", fields: [awayTeamId], references: [id])
  homeTeam    Team             @relation("HomeTeam", fields: [homeTeamId], references: [id])

  @@index([gameweek])
  @@index([kickoffTime])
  @@map("matches")
}

model FPLPlayerStats {
  id              Int      @id @default(autoincrement())
  playerId        Int
  matchId         Int
  gameweek        Int
  minutes         Int
  goals           Int      @default(0)
  assists         Int      @default(0)
  cleanSheets     Int      @default(0)
  goalsConceded   Int      @default(0)
  ownGoals        Int      @default(0)
  penaltiesSaved  Int      @default(0)
  penaltiesMissed Int      @default(0)
  yellowCards     Int      @default(0)
  redCards        Int      @default(0)
  saves           Int      @default(0)
  bonus           Int      @default(0)
  bps             Int      @default(0)
  totalPoints     Int
  influence       Float
  creativity      Float
  threat          Float
  ictIndex        Float
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  match           Match    @relation(fields: [matchId], references: [id])
  player          Player   @relation(fields: [playerId], references: [id])

  @@unique([playerId, matchId])
  @@index([gameweek])
  @@map("fpl_player_stats")
}

model ExternalPlayerStats {
  id            Int      @id @default(autoincrement())
  playerId      Int
  gameweek      Int
  source        String
  minutes       Int?
  goals         Int?
  assists       Int?
  shots         Int?
  shotsOnTarget Int?
  keyPasses     Int?
  xG            Float?
  xA            Float?
  xGChain       Float?
  xGBuildup     Float?
  rating        Float?
  touches       Int?
  passAccuracy  Float?
  dribbles      Int?
  aerialDuels   Int?
  rawData       Json?
  matchDate     DateTime
  homeTeam      String
  awayTeam      String
  wasHome       Boolean
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  player        Player   @relation(fields: [playerId], references: [id])

  @@unique([playerId, gameweek, source])
  @@index([gameweek])
  @@index([source])
  @@map("external_player_stats")
}

model ExternalTeamStats {
  id            Int      @id @default(autoincrement())
  teamId        Int
  gameweek      Int
  source        String
  matchDate     DateTime
  isHome        Boolean
  opponentId    Int?
  goals         Int
  goalsConceded Int
  xG            Float
  xGA           Float
  npxG          Float
  npxGA         Float
  deep          Int
  deepAllowed   Int
  ppda          Float
  ppdaAllowed   Float
  xpts          Float
  result        String
  points        Int
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  team          Team     @relation(fields: [teamId], references: [id])

  @@unique([teamId, matchDate, source])
  @@index([teamId])
  @@index([source])
  @@map("external_team_stats")
}

model User {
  id           Int           @id @default(autoincrement())
  email        String        @unique
  name         String?
  fplTeamId    Int?          @unique
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  lastLoginAt  DateTime?
  password     String?
  fantasyTeams FantasyTeam[]
  watchlist    Watchlist[]

  @@map("users")
}

model FantasyTeam {
  id                     Int               @id @default(autoincrement())
  userId                 Int
  gameweek               Int
  teamValue              Int
  bank                   Int
  freeTransfers          Int
  pointsHit              Int               @default(0)
  chipUsed               ChipType?
  gameweekPoints         Int?
  totalPoints            Int?
  gameweekRank           Int?
  overallRank            Int?
  createdAt              DateTime          @default(now())
  updatedAt              DateTime          @updatedAt
  benchBoostAvailable    Boolean           @default(true)
  freeHitAvailable       Boolean           @default(true)
  transfersMade          Int               @default(0)
  tripleCaptainAvailable Boolean           @default(true)
  wildcardAvailable      Boolean           @default(true)
  picks                  FantasyTeamPick[]
  user                   User              @relation(fields: [userId], references: [id])

  @@unique([userId, gameweek])
  @@index([gameweek])
  @@map("fantasy_teams")
}

model FantasyTeamPick {
  id            Int         @id @default(autoincrement())
  fantasyTeamId Int
  playerId      Int
  position      Int
  isCaptain     Boolean     @default(false)
  isViceCaptain Boolean     @default(false)
  multiplier    Int         @default(1)
  purchasePrice Int?
  sellingPrice  Int?
  fantasyTeam   FantasyTeam @relation(fields: [fantasyTeamId], references: [id], onDelete: Cascade)
  player        Player      @relation(fields: [playerId], references: [id])

  @@unique([fantasyTeamId, position])
  @@map("fantasy_team_picks")
}

model Watchlist {
  id         Int      @id @default(autoincrement())
  userId     Int
  playerId   Int
  addedAt    DateTime @default(now())
  reason     String?
  priceAtAdd Int?
  player     Player   @relation(fields: [playerId], references: [id])
  user       User     @relation(fields: [userId], references: [id])

  @@unique([userId, playerId])
  @@map("watchlist")
}

model SyncLog {
  id             Int       @id @default(autoincrement())
  source         String
  syncType       String
  gameweek       Int?
  success        Boolean
  recordsUpdated Int       @default(0)
  recordsFailed  Int       @default(0)
  errorMessage   String?
  startedAt      DateTime  @default(now())
  completedAt    DateTime?
  duration       Int?

  @@index([source, syncType])
  @@index([startedAt])
  @@map("sync_logs")
}

model AppConfig {
  id          Int      @id @default(autoincrement())
  key         String   @unique
  value       String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("app_config")
}

enum Position {
  GOALKEEPER
  DEFENDER
  MIDFIELDER
  FORWARD
}

enum MappingMethod {
  EXACT_MATCH
  FUZZY_MATCH
  MANUAL
  AI_SUGGESTED
}

enum MappingStatus {
  CONFIRMED
  PENDING
  FAILED
  IGNORED
}

enum ChipType {
  WILDCARD
  FREE_HIT
  BENCH_BOOST
  TRIPLE_CAPTAIN
}
